generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["views"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model user {
  id                        Int                       @unique @default(autoincrement())
  firstName                 String
  lastName                  String
  phoneNumber               String
  email                     String                    @unique
  password                  String
  isVerified                Boolean                   @default(false)
  status                    user_status               @default(ENABLED)
  createdAt                 DateTime                  @default(now())
  modifiedAt                DateTime                  @default(now()) @updatedAt
  contact_logs              contact_log[]
  user_role                 user_role[]
  user_sessions             user_session[]
  user_verification_tokens  user_verification_token[]
  created_bookings          booking[]                 @relation("BookingCreatedBy")
  modified_bookings         booking[]                 @relation("BookingModifiedBy")
  created_booking_items     booking_item[]            @relation("BookingItemCreatedBy")
  modified_booking_items    booking_item[]            @relation("BookingItemModifiedBy")
  created_deliveries        delivery[]                @relation("DeliveryCreatedBy")
  modified_deliveries       delivery[]                @relation("DeliveryModifiedBy")
  created_services          service[]                 @relation("ServiceCreatedBy")
  modified_services         service[]                 @relation("ServiceModifiedBy")
  created_booking_payments  booking_payment[]         @relation("BookingPaymentCreatedBy")
  modified_booking_payments booking_payment[]         @relation("BookingPaymentModifiedBy")
  created_refunds           refund[]                  @relation("RefundCreatedBy")
  modified_refunds          refund[]                  @relation("RefundModifiedBy")
  created_warranties        warranty[]                @relation("WarrantyCreatedBy")
  modified_warranties       warranty[]                @relation("WarrantyModifiedBy")
  created_warranty_claims   warranty_claim[]          @relation("WarrantyClaimCreatedBy")
  modified_warranty_claims  warranty_claim[]          @relation("WarrantyClaimModifiedBy")
  created_locations         location[]                @relation("LocationCreatedBy")
  modified_locations        location[]                @relation("LocationModifiedBy")
  created_expense_entries   expense_entry[]           @relation("ExpenseEntryCreatedBy")
  modified_expense_entries  expense_entry[]           @relation("ExpenseEntryModifiedBy")
  created_clients           client[]                  @relation("ClientCreatedBy")
  modified_clients          client[]                  @relation("ClientModifiedBy")
}

model user_session {
  id           Int      @id @default(autoincrement())
  userId       Int
  refreshToken String   @unique
  createdAt    DateTime @default(now())
  user         user     @relation(fields: [userId], references: [id])
}

model user_verification_token {
  id        Int        @id @default(autoincrement())
  userId    Int
  token     String     @unique
  type      token_type
  expiresAt DateTime

  user user @relation(fields: [userId], references: [id])

  @@unique([userId, type])
}

enum token_type {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

model system_configuration {
  id          Int     @unique @default(autoincrement())
  key         String  @unique
  value       String  @db.Text
  description String?
  isActive    Boolean @default(true)
}

model booking {
  id                    Int                    @unique @default(autoincrement())
  clientName            String
  phoneNumber           String
  whatsappNumber        String
  status                booking_status         @default(DRAFT)
  paymentStatus         booking_payment_status @default(PENDING)
  code                  String                 @unique
  payableAmount         Int?
  paidAmount            Int?
  createdAt             DateTime               @default(now())
  modifiedAt            DateTime               @default(now()) @updatedAt
  isActive              Boolean                @default(true)
  isWarrantyClaim       Boolean                @default(false)
  appointmentDate       DateTime?
  createdBy             Int
  modifiedBy            Int
  locationId            Int
  clientType            client_type            @default(INDIVIDUAL)
  clientId              Int?
  referralSource        ReferralSource?
  referralSourceNotes   String?                @db.VarChar(500)
  comments              String?                @db.Text
  location              location               @relation(fields: [locationId], references: [id])
  client                client?                @relation(fields: [clientId], references: [id])
  booking_items         booking_item[]
  delivery              delivery[]
  contact_log           contact_log[]
  booking_payments      booking_payment[]
  warrantyClaims        warranty_claim[]       @relation("WarrantyClaimBooking")
  originalBookingClaims warranty_claim[]       @relation("OriginalBookingClaims")
  createdByUser         user                   @relation("BookingCreatedBy", fields: [createdBy], references: [id])
  modifiedByUser        user                   @relation("BookingModifiedBy", fields: [modifiedBy], references: [id])

  @@index([clientId, status, isActive])
}

model booking_item {
  id             Int                 @unique @default(autoincrement())
  code           String?             @unique
  name           String
  serialNumber   String?
  type           booking_item_type
  reportedIssue  String?
  payableAmount  Int
  paidAmount     Int?
  comments       String?
  status         booking_item_status @default(DRAFT)
  createdAt      DateTime            @default(now())
  modifiedAt     DateTime            @default(now()) @updatedAt
  isActive       Boolean             @default(true)
  createdBy      Int
  modifiedBy     Int
  bookingId      Int
  paymentId      Int?
  discount       Int?
  vendor         String?
  service        service[]
  contact_log    contact_log[]
  warranty       warranty?
  payment        booking_payment?    @relation(fields: [paymentId], references: [id])
  booking        booking             @relation(fields: [bookingId], references: [id])
  createdByUser  user                @relation("BookingItemCreatedBy", fields: [createdBy], references: [id])
  modifiedByUser user                @relation("BookingItemModifiedBy", fields: [modifiedBy], references: [id])
}

model delivery {
  id                   Int             @unique @default(autoincrement())
  booking              booking         @relation(fields: [bookingId], references: [id])
  bookingId            Int
  status               delivery_status
  address              String
  postalCode           Int
  courier              String
  type                 courier_type
  phoneNumber          String
  createdAt            DateTime        @default(now())
  modifiedAt           DateTime        @default(now()) @updatedAt
  landmark             String?
  secondaryPhoneNumber String?
  deliveryDate         DateTime
  isActive             Boolean         @default(true)
  createdBy            Int
  modifiedBy           Int
  createdByUser        user            @relation("DeliveryCreatedBy", fields: [createdBy], references: [id])
  modifiedByUser       user            @relation("DeliveryModifiedBy", fields: [modifiedBy], references: [id])
}

model service {
  id             Int            @unique @default(autoincrement())
  booking_item   booking_item   @relation(fields: [bookingItemId], references: [id])
  bookingItemId  Int
  status         service_status
  remarks        String
  createdAt      DateTime       @default(now())
  modifiedAt     DateTime       @default(now()) @updatedAt
  isActive       Boolean        @default(true)
  createdBy      Int
  modifiedBy     Int
  createdByUser  user           @relation("ServiceCreatedBy", fields: [createdBy], references: [id])
  modifiedByUser user           @relation("ServiceModifiedBy", fields: [modifiedBy], references: [id])
}

model contact_log {
  id            Int            @unique @default(autoincrement())
  booking_item  booking_item   @relation(fields: [bookingItemId], references: [id])
  bookingItemId Int
  user          user           @relation(fields: [userId], references: [id])
  userId        Int
  booking       booking        @relation(fields: [bookingId], references: [id])
  bookingId     Int
  contactedAt   DateTime
  status        contact_method
  notes         String
  createdAt     DateTime       @default(now())
  modifiedAt    DateTime       @default(now()) @updatedAt
  isActive      Boolean        @default(true)
}

model booking_payment {
  id             Int            @unique @default(autoincrement())
  booking        booking        @relation(fields: [bookingId], references: [id])
  bookingId      Int
  status         payment_status
  payableAmount  Int?
  paidAmount     Int?
  createdAt      DateTime       @default(now())
  modifiedAt     DateTime       @default(now()) @updatedAt
  isActive       Boolean        @default(true)
  paymentMethod  payment_method
  recipientName  String?
  transactionId  String?
  createdBy      Int
  modifiedBy     Int
  refund         refund[]
  bookingItem    booking_item[]
  createdByUser  user           @relation("BookingPaymentCreatedBy", fields: [createdBy], references: [id])
  modifiedByUser user           @relation("BookingPaymentModifiedBy", fields: [modifiedBy], references: [id])
}

model refund {
  id              Int             @unique @default(autoincrement())
  booking_payment booking_payment @relation(fields: [paymentId], references: [id])
  paymentId       Int
  refundDate      DateTime
  remarks         String?
  createdAt       DateTime        @default(now())
  modifiedAt      DateTime        @default(now()) @updatedAt
  amount          Int
  isActive        Boolean         @default(true)
  createdBy       Int
  modifiedBy      Int
  createdByUser   user            @relation("RefundCreatedBy", fields: [createdBy], references: [id])
  modifiedByUser  user            @relation("RefundModifiedBy", fields: [modifiedBy], references: [id])
}

model system_role {
  id        Int         @unique @default(autoincrement())
  name      String
  isActive  Boolean     @default(true)
  user_role user_role[]
}

model user_role {
  id         Int         @unique @default(autoincrement())
  user       user        @relation(fields: [userId], references: [id])
  userId     Int
  systemRole system_role @relation(fields: [roleId], references: [id])
  roleId     Int
  isActive   Boolean     @default(true)
}

enum user_status {
  ENABLED
  DISABLED
}

enum payment_method {
  CASH
  WALLET
  BANK_TRANSFER
}

enum payment_status {
  PENDING
  PAID
}

enum booking_payment_status {
  PENDING
  PARTIAL_PAID
  PAID
  REFUNDED
  PARTIAL_REFUND
  NOT_APPLICABLE
}

enum contact_method {
  SMS
  CALL
  EMAIL
}

enum service_status {
  PENDING
  IN_REPAIR
  IN_QA
  QA_PASSED
  QA_FAILED
}

enum delivery_status {
  PENDING
  IN_TRANSIT_INBOUND
  IN_TRANSIT_OUTBOUND
  IN_WAREHOUSE
  DELIVERED
  PENDING_INBOUND
  PENDING_OUTBOUND
}

enum booking_status {
  DRAFT
  PENDING
  IN_REVIEW
  CONFIRMED
  PENDING_DELIVERY
  IN_QUEUE
  IN_PROGRESS
  RESOLVED
  PENDING_PAYMENT
  REJECTED
  COMPLETED
  CANCELLED
  EXPIRED
  DELETED
}

enum booking_item_status {
  DRAFT
  PENDING
  IN_PROGRESS
  REPAIRED
  NOT_REPAIRED
  NO_ISSUE
}

enum booking_item_resolution_status {
  RESOLVE
  REJECT
}

enum booking_item_type {
  GPU
  MOBO
  LAPTOP
}

enum courier_type {
  INBOUND
  OUTBOUND
}

enum client_type {
  CORPORATE
  INDIVIDUAL
}

enum ReferralSource {
  FACEBOOK
  WHATSAPP
  INSTAGRAM
  WEBSITE
  GOOGLE_SEARCH
  FRIEND_REFERRAL
  BUSINESS_REFERRAL
  EXISTING_CUSTOMER
  ONLINE_REVIEW
  FORUM_COMMUNITY
  OTHER
}

enum client_status {
  ACTIVE
  SUSPENDED
  CREDIT_HOLD
  INACTIVE
}

model client {
  id                 Int           @unique @default(autoincrement())
  businessName       String
  code               String        @unique
  contactPersonName  String
  phoneNumber        String
  whatsappNumber     String
  email              String?
  businessAddress    String?
  city               String?
  postalCode         String?
  paymentTermsDays   Int           @default(30)
  creditLimit        Int?
  status             client_status @default(ACTIVE)
  totalPayable       Int           @default(0)
  totalPaid          Int           @default(0)
  outstandingBalance Int           @default(0)
  locationId         Int
  location           location      @relation(fields: [locationId], references: [id])
  notes              String?       @db.Text
  createdAt          DateTime      @default(now())
  modifiedAt         DateTime      @default(now()) @updatedAt
  isActive           Boolean       @default(true)
  createdBy          Int
  modifiedBy         Int
  createdByUser      user          @relation("ClientCreatedBy", fields: [createdBy], references: [id])
  modifiedByUser     user          @relation("ClientModifiedBy", fields: [modifiedBy], references: [id])
  bookings           booking[]

  @@index([businessName, phoneNumber, status, isActive])
  @@index([locationId, status])
  @@index([code])
}

model warranty {
  id                 Int                   @unique @default(autoincrement())
  bookingItemId      Int                   @unique
  bookingItem        booking_item          @relation(fields: [bookingItemId], references: [id])
  warrantyStartDate  DateTime
  warrantyEndDate    DateTime
  warrantyDays       Int                   @default(15)
  isActive           Boolean               @default(true)
  createdAt          DateTime              @default(now())
  modifiedAt         DateTime              @default(now()) @updatedAt
  createdBy          Int
  modifiedBy         Int
  createdByUser      user                  @relation("WarrantyCreatedBy", fields: [createdBy], references: [id])
  modifiedByUser     user                  @relation("WarrantyModifiedBy", fields: [modifiedBy], references: [id])
  warrantyClaimItems warranty_claim_item[]
}

model warranty_claim {
  id                 Int                   @unique @default(autoincrement())
  originalBookingId  Int
  originalBooking    booking               @relation("OriginalBookingClaims", fields: [originalBookingId], references: [id])
  claimBookingId     Int
  claimBooking       booking               @relation("WarrantyClaimBooking", fields: [claimBookingId], references: [id])
  claimNumber        String                @unique
  claimDate          DateTime              @default(now())
  remarks            String?
  isActive           Boolean               @default(true)
  createdAt          DateTime              @default(now())
  modifiedAt         DateTime              @default(now()) @updatedAt
  createdBy          Int
  modifiedBy         Int
  createdByUser      user                  @relation("WarrantyClaimCreatedBy", fields: [createdBy], references: [id])
  modifiedByUser     user                  @relation("WarrantyClaimModifiedBy", fields: [modifiedBy], references: [id])
  warrantyClaimItems warranty_claim_item[]
}

model warranty_claim_item {
  id              Int            @unique @default(autoincrement())
  warrantyClaimId Int
  warrantyClaim   warranty_claim @relation(fields: [warrantyClaimId], references: [id])
  warrantyId      Int
  warranty        warranty       @relation(fields: [warrantyId], references: [id])
  reportedIssue   String
  remarks         String?
  createdAt       DateTime       @default(now())
  modifiedAt      DateTime       @default(now()) @updatedAt
}

model location {
  id              Int             @unique @default(autoincrement())
  name            String
  code            String          @unique
  country         String
  address         String?
  city            String?
  postalCode      String?
  phoneNumber     String?
  managerName     String?
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  modifiedAt      DateTime        @default(now()) @updatedAt
  createdBy       Int
  modifiedBy      Int
  createdByUser   user            @relation("LocationCreatedBy", fields: [createdBy], references: [id])
  modifiedByUser  user            @relation("LocationModifiedBy", fields: [modifiedBy], references: [id])
  expense_entries expense_entry[]
  bookings        booking[]
  clients         client[]
}

model expense_entry {
  id                Int                    @unique @default(autoincrement())
  entryDate         DateTime
  locationId        Int
  location          location               @relation(fields: [locationId], references: [id])
  category          expense_category
  amount            Int
  paymentMethod     expense_payment_method @default(CASH)
  description       String
  remarks           String?
  receiptNumber     String?
  receiptAttachment String?
  vendorName        String?
  isActive          Boolean                @default(true)
  createdAt         DateTime               @default(now())
  modifiedAt        DateTime               @default(now()) @updatedAt
  createdBy         Int
  modifiedBy        Int
  createdByUser     user                   @relation("ExpenseEntryCreatedBy", fields: [createdBy], references: [id])
  modifiedByUser    user                   @relation("ExpenseEntryModifiedBy", fields: [modifiedBy], references: [id])

  @@index([entryDate, category, isActive])
}

enum expense_category {
  RENT
  UTILITIES
  SALARIES
  EQUIPMENT
  MAINTENANCE
  MARKETING
  SHIPMENT
  FOOD
  REFRESHMENTS
  MISCELLANEOUS
}

enum expense_payment_method {
  CASH
  BANK_TRANSFER
  WALLET
  CHEQUE
  CREDIT_CARD
  DEBIT_CARD
}

/// aggregates booking data by customer (booking phone number)
view customer_first_booking {
  phoneNumber      String   @unique
  firstBookingDate DateTime
  totalBookings    Int
  totalRevenue     Int
  totalPaid        Int
}

/// breaks down revenue by payment status
view revenue_by_payment_status {
  paymentStatus  String @unique
  bookingCount   Int
  totalRevenue   Int
  totalCollected Int
  outstanding    Int
}

/// aggregates repair success rates by item type
view repair_stats_by_type {
  type          String   @unique
  totalItems    Int
  repaired      Int
  notRepaired   Int
  successRate   Decimal?
  avgRepairDays Decimal?
}

/// View: Daily Revenue Summary
/// Aggregates revenue by date for trend analysis
view daily_revenue_summary {
  date        DateTime @unique
  bookings    Int
  revenue     Int
  collected   Int
  outstanding Int
}
